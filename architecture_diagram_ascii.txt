================================================================================
    CAREER PATH NAVIGATOR - LLM INFRASTRUCTURE ARCHITECTURE
================================================================================

┌─────────────────────────────────────────────────────────────────────────┐
│                         RAILS APPLICATION LAYER                          │
│  ┌──────────────┐         ┌──────────────┐                              │
│  │  Rails App   │────────▶│ Config Loader│                              │
│  │ (Career Path │         │ (JSON Parser)│                              │
│  │  Navigator)  │         └──────┬───────┘                              │
│  └──────┬───────┘                │                                       │
│         │                        │                                       │
│         │ HTTP Request           │ Reads                                 │
│         │                        ▼                                       │
│         │                ┌───────────────┐                               │
│         │                │ JSON Config   │                               │
│         │                │   Files       │                               │
│         │                └───────────────┘                               │
└─────────┼───────────────────────────────────────────────────────────────┘
          │
          │ HTTP API Call
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        LLM GATEWAY SERVICE                               │
│                    (Python FastAPI - Async)                              │
│                                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │
│  │   Request    │  │    Cache    │  │ Rate Limiter │                   │
│  │  Validator   │  │   (Redis)   │  │ (Token-based)│                   │
│  └──────┬───────┘  └──────┬──────┘  └──────┬───────┘                   │
│         │                 │                 │                            │
│         └─────────────────┼─────────────────┘                            │
│                           │                                               │
│                           ▼                                               │
│                  ┌─────────────────┐                                      │
│                  │ Request Router  │                                      │
│                  │ (A/B Test Logic)│                                      │
│                  └────────┬────────┘                                      │
│                           │                                               │
└───────────────────────────┼───────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    PROVIDER ABSTRACTION LAYER                            │
│                                                                           │
│  ┌──────────────────────────────────────────────────────┐                │
│  │            Provider Manager                          │                │
│  │  - A/B Testing Logic                                 │                │
│  │  - Provider Selection                                │                │
│  │  - Performance Tracking                             │                │
│  └──────┬───────────────────────────────┬───────────────┘                │
│         │                               │                                │
│         ▼                               ▼                                │
│  ┌──────────────┐              ┌──────────────┐                          │
│  │ GPT-4 Adapter│              │Claude Adapter│                          │
│  │  - API Calls │              │  - API Calls │                          │
│  │  - Formatting│              │  - Formatting│                          │
│  └──────┬───────┘              └──────┬───────┘                          │
│         │                              │                                 │
│         │                              │                                 │
│         └──────────┬───────────────────┘                                 │
│                    │                                                      │
│                    ▼                                                      │
│         ┌──────────────────┐                                             │
│         │ Failover Handler │                                             │
│         │ Circuit Breaker  │                                             │
│         └────────┬─────────┘                                             │
└──────────────────┼───────────────────────────────────────────────────────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
┌──────────────┐    ┌──────────────┐
│  OpenAI API  │    │ Anthropic API│
│    GPT-4     │    │ Claude-3.5   │
└──────────────┘    └──────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                        OBSERVABILITY LAYER                               │
│                                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │
│  │   Metrics    │  │     Logs     │  │    Traces    │                   │
│  │ (Prometheus) │  │(ELK/CloudWatch)│(OpenTelemetry)│                   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                   │
│         │                 │                 │                            │
│         └─────────────────┼─────────────────┘                            │
│                           │                                               │
│                           ▼                                               │
│                  ┌─────────────────┐                                      │
│                  │  Alert Manager │                                      │
│                  │  - Latency     │                                      │
│                  │  - Errors      │                                      │
│                  │  - Budget      │                                      │
│                  └─────────────────┘                                      │
└───────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                      CONFIGURATION MANAGEMENT                            │
│                                                                           │
│  ┌──────────────┐                                                        │
│  │ Config Store │                                                        │
│  │ (S3/GitHub)  │                                                        │
│  └──────┬───────┘                                                        │
│         │                                                                 │
│         │ Sync                                                           │
│         ▼                                                                 │
│  ┌──────────────┐                                                        │
│  │ Config Sync  │                                                        │
│  │   Service    │                                                        │
│  └──────┬───────┘                                                        │
│         │                                                                 │
│         ├────────────────────────────────────┐                          │
│         │                                    │                          │
│         ▼                                    ▼                          │
│  ┌──────────────┐              ┌──────────────────────┐                │
│  │ JSON Config  │              │   Gateway Service    │                │
│  │   Files:     │              │   (Hot Reload)       │                │
│  │ - provider_  │              └──────────────────────┘                │
│  │   settings   │                                                    │
│  │ - ab_test_   │                                                    │
│  │   config     │                                                    │
│  │ - rate_      │                                                    │
│  │   limits     │                                                    │
│  └──────────────┘                                                    │
└───────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                          DATA PIPELINE                                   │
│                                                                           │
│  ┌──────────────┐                                                        │
│  │  Databricks  │                                                        │
│  │  ML Pipeline │                                                        │
│  └──────┬───────┘                                                        │
│         │                                                                 │
│         │ Enrichment Data                                                │
│         ▼                                                                 │
│  ┌──────────────┐                                                        │
│  │ Job Market   │                                                        │
│  │     Data     │                                                        │
│  └──────────────┘                                                        │
└───────────────────────────────────────────────────────────────────────────┘


================================================================================
                            REQUEST FLOW
================================================================================

1. User Request → Rails App
2. Rails → Load Config (JSON files)
3. Rails → HTTP Call to LLM Gateway
4. Gateway → Check Cache (Redis)
5. Gateway → Validate Rate Limits
6. Gateway → Route to Provider (A/B Test)
7. Provider Adapter → Call LLM API
8. Response → Cache (if cacheable)
9. Response → Emit Metrics/Logs
10. Response → Return to Rails → User


================================================================================
                          FAILOVER STRATEGY
================================================================================

Primary Provider (A/B Selected)
    │
    ├─▶ Success → Return Response
    │
    └─▶ Failure → Circuit Breaker
                    │
                    ├─▶ Circuit Open → Use Backup Provider
                    │
                    └─▶ Backup Fails → Return Cached Response
                                         │
                                         └─▶ No Cache → Graceful Degradation


================================================================================
                          KEY METRICS
================================================================================

• Request Rate: requests/second
• Latency: p50, p95, p99 (< 3s target at p95)
• Token Usage: per provider, per day
• Cost Tracking: $/hour, $/day, $/month
• Error Rates: by provider
• Cache Hit Rate: %
• Circuit Breaker State: open/closed/half-open

